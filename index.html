<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MoneyTracker AI</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .swipe-container { transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1); touch-action: pan-y; }
        .actions-container { position: absolute; right: 0; top: 0; bottom: 0; width: 160px; display: flex; z-index: 1; }
        .edit-btn { width: 80px; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 0; }
        .delete-btn { width: 80px; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 0 1.5rem 1.5rem 0; }
        #ptr { text-align: center; height: 0; overflow: hidden; transition: height 0.2s; background: #f8fafc; color: #94a3b8; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-slate-50 pb-32 font-sans text-slate-900 overflow-x-hidden">

    <div id="ptr">Aggiornamento...</div>

    <div class="p-6 bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="flex justify-between items-center mb-2">
            <button onclick="changeMonth(-1)" class="p-2 text-slate-400 font-bold text-lg">‚ùÆ</button>
            <h1 id="currentMonthDisplay" class="text-sm font-black uppercase tracking-widest text-slate-400">Caricamento...</h1>
            <button onclick="changeMonth(1)" class="p-2 text-slate-400 font-bold text-lg">‚ùØ</button>
        </div>
        <div class="text-center">
            <p id="totalBalance" class="text-3xl font-black text-emerald-600">‚Ç¨ 0.00</p>
        </div>
    </div>

    <div class="p-4 flex flex-col items-center bg-white m-4 rounded-[2.5rem] shadow-sm border border-slate-100">
        <div style="width: 100%; max-width: 200px;">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <div class="mx-4 mb-8">
        <h2 class="text-[10px] font-black text-gray-400 mb-4 uppercase tracking-widest text-center">Movimenti e Riporti</h2>
        <div id="transactionList" class="space-y-3"></div>
    </div>

    <div class="fixed bottom-24 right-6 flex flex-col gap-4 z-30">
        <button onclick="openModal('uscita')" class="bg-red-500 text-white w-14 h-14 rounded-full text-2xl shadow-xl font-bold active:scale-90 transition-transform">-</button>
        <button onclick="openModal('entrata')" class="bg-emerald-500 text-white w-14 h-14 rounded-full text-2xl shadow-xl font-bold active:scale-90 transition-transform">+</button>
    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-4 text-[10px] font-bold text-gray-400 z-40">
        <a href="index.html" class="text-slate-800 flex flex-col items-center gap-1">üè† <span>Home</span></a>
        <a href="risparmi.html" class="flex flex-col items-center gap-1">üí∞ <span>Risparmi</span></a>
        <a href="abbonamenti.html" class="flex flex-col items-center gap-1">üì∫ <span>Abbonamenti</span></a>
        <a href="satispay.html" class="flex flex-col items-center gap-1">üì± <span>Satispay</span></a>
        <a href="analisi.html" class="flex flex-col items-center gap-1">üìà <span>Analisi</span></a>
    </nav>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end justify-center z-50">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] p-8 animate-slide-up">
            <h2 id="modalTitle" class="text-2xl font-black mb-6 text-slate-800">Nuova Operazione</h2>
            <form id="transactionForm" class="space-y-4">
                <input type="hidden" id="edit_id">
                <input type="hidden" id="tipo">
                <select id="categoria" class="w-full p-4 bg-slate-100 rounded-2xl font-semibold border-none" required></select>
                <input type="number" id="importo" step="0.01" class="w-full p-4 bg-slate-100 rounded-2xl font-bold text-xl border-none text-slate-800" placeholder="0.00" required>
                <select id="metodo" class="w-full p-4 bg-slate-100 rounded-2xl font-semibold border-none text-slate-700">
                    <option value="Carta">Carta üí≥</option>
                    <option value="Satispay">Satispay üì±</option>
                    <option value="Contanti">Contanti üíµ</option>
                </select>
                <input type="text" id="descrizione" class="w-full p-4 bg-slate-100 rounded-2xl font-semibold border-none text-slate-700" placeholder="Descrizione">
                <input type="date" id="data" class="w-full p-4 bg-slate-100 rounded-2xl font-semibold border-none text-slate-700">
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 py-4 text-gray-400 font-bold">Annulla</button>
                    <button type="submit" class="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg">Salva</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vdbgzqzquuvvcqgntsgh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYmd6cXpxdXV2dmNxZ250c2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MjY2MDEsImV4cCI6MjA4NzUwMjYwMX0.pTjNAQ6dYb0zNbL7DW2yf9ud50tsn1GrfIsX1XA0oXE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentDate = new Date();
        let xDown = null, activeSwipeElement = null;

        const ctx = document.getElementById('myChart').getContext('2d');
        let myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ data: [], backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6', '#f472b6', '#06b6d4', '#fb923c'], borderWidth: 0 }] },
            options: { cutout: '80%', plugins: { legend: { display: false } } }
        });

        // Swipe Logic
        window.addEventListener('touchstart', (e) => { xDown = e.touches[0].clientX; }, {passive: true});
        window.addEventListener('touchmove', (e) => {
            const container = e.target.closest('.swipe-container');
            if (container) {
                let xDiff = xDown - e.touches[0].clientX;
                if (Math.abs(xDiff) > 20) {
                    if (xDiff > 0) container.style.transform = 'translateX(-160px)';
                    else container.style.transform = 'translateX(0)';
                    activeSwipeElement = container;
                }
            }
        }, {passive: true});

        async function updateUI() {
            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            document.getElementById('currentMonthDisplay').innerText = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString();

            const { data: pastData } = await supabaseClient.from('transactions').select('importo, tipo').lt('data_transazione', firstDay);
            let riporto = 0;
            pastData?.forEach(t => { riporto += (t.tipo === 'entrata' ? t.importo : -t.importo); });

            const { data: currentData } = await supabaseClient.from('transactions').select('*').gte('data_transazione', firstDay).lte('data_transazione', lastDay).order('data_transazione', {ascending: false});
            
            let saldoMese = 0;
            const aggregato = {};
            let listHtml = '';

            currentData?.forEach(t => {
                if (t.tipo === 'entrata') saldoMese += t.importo;
                else { saldoMese -= t.importo; aggregato[t.categoria] = (aggregato[t.categoria] || 0) + t.importo; }
                
                listHtml += `
                <div class="relative overflow-hidden rounded-2xl mb-3 shadow-sm bg-slate-200">
                    <div class="actions-container">
                        <div class="edit-btn" onclick="prepareEdit(${JSON.stringify(t).replace(/"/g, '&quot;')})">Edit</div>
                        <div class="delete-btn" onclick="deleteTransaction(${t.id})">Del</div>
                    </div>
                    <div class="swipe-container bg-white p-4 relative z-10 flex justify-between items-center border border-slate-100 rounded-2xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-lg">${t.categoria.split(' ').pop()}</div>
                            <div>
                                <p class="font-bold text-sm text-slate-800">${t.descrizione || t.categoria}</p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">${t.data_transazione}</p>
                            </div>
                        </div>
                        <p class="font-black ${t.tipo === 'entrata' ? 'text-emerald-500' : 'text-slate-700'}">
                            ${t.tipo === 'entrata' ? '+' : '-'} ‚Ç¨${t.importo.toFixed(2)}
                        </p>
                    </div>
                </div>`;
            });

            document.getElementById('totalBalance').innerText = `‚Ç¨ ${(riporto + saldoMese).toFixed(2)}`;
            document.getElementById('transactionList').innerHTML = listHtml || '<p class="text-center text-slate-400 py-10 italic">Nessun movimento</p>';
            
            myChart.data.labels = Object.keys(aggregato);
            myChart.data.datasets[0].data = Object.values(aggregato);
            myChart.update();
        }

        async function checkAutomaticSavings() {
            const oggi = new Date();
            const giornoOggi = oggi.getDate();
            const dataOggiISO = oggi.toISOString().split('T')[0];
            const meseCorrente = oggi.getMonth();
            const annoCorrente = oggi.getFullYear();

            const { data: piani } = await supabaseClient.from('savings_plans').select('*').eq('giorno_prelievo', giornoOggi);
            if (!piani) return;

            for (const piano of piani) {
                const ultimoVersamento = piano.ultimo_versamento ? new Date(piano.ultimo_versamento) : null;
                const giaVersato = ultimoVersamento && ultimoVersamento.getMonth() === meseCorrente && ultimoVersamento.getFullYear() === annoCorrente;

                if (!giaVersato && piano.importo_mensile > 0) {
                    await supabaseClient.from('transactions').insert([{
                        tipo: 'uscita', categoria: 'Risparmi üí∞', importo: piano.importo_mensile,
                        metodo_pagamento: 'Contanti', descrizione: `Auto PAC: ${piano.nome}`, data_transazione: dataOggiISO
                    }]);
                    await supabaseClient.from('savings_plans').update({
                        attuale: parseFloat(piano.attuale) + parseFloat(piano.importo_mensile),
                        ultimo_versamento: dataOggiISO
                    }).eq('id', piano.id);
                }
            }
            updateUI();
        }

        function prepareEdit(t) {
            openModal(t.tipo);
            document.getElementById('modalTitle').innerText = "Modifica Operazione";
            document.getElementById('edit_id').value = t.id;
            document.getElementById('categoria').value = t.categoria;
            document.getElementById('importo').value = t.importo;
            document.getElementById('metodo').value = t.metodo_pagamento;
            document.getElementById('descrizione').value = t.descrizione;
            document.getElementById('data').value = t.data_transazione;
            if (activeSwipeElement) activeSwipeElement.style.transform = 'translateX(0)';
        }

        function openModal(tipo) {
            document.getElementById('modalTitle').innerText = "Nuova Operazione";
            document.getElementById('edit_id').value = "";
            document.getElementById('tipo').value = tipo;
            const cats = tipo === 'entrata' ? ["Stipendio üí∞", "Regalo üéÅ", "Extra üìà"] : ["Spesa üõí", "Cibo üçï", "Svago üçø", "Affitto üè†", "Trasporti üöó", "Telefono üì±", "Abbonamenti üì∫", "Salute üíä", "Risparmi üí∞"];
            document.getElementById('categoria').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); document.getElementById('transactionForm').reset(); }

        document.getElementById('transactionForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit_id').value;
            const payload = {
                tipo: document.getElementById('tipo').value,
                categoria: document.getElementById('categoria').value,
                importo: parseFloat(document.getElementById('importo').value),
                metodo_pagamento: document.getElementById('metodo').value,
                descrizione: document.getElementById('descrizione').value,
                data_transazione: document.getElementById('data').value
            };
            if (id) await supabaseClient.from('transactions').update(payload).eq('id', id);
            else await supabaseClient.from('transactions').insert([payload]);
            closeModal();
            updateUI();
        };

        async function deleteTransaction(id) {
            if(confirm("Eliminare?")) { await supabaseClient.from('transactions').delete().eq('id', id); updateUI(); }
        }

        function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); updateUI(); }
        
        // Init
        updateUI();
        checkAutomaticSavings();
    </script>
</body>
</html>
