<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyTracker AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 pb-24 font-sans text-slate-900">

    <div class="p-6 bg-white shadow-sm border-b sticky top-0 z-10 text-center">
        <h1 class="text-xl font-bold text-slate-800">Il Mio Portafoglio</h1>
        <p id="totalBalance" class="text-2xl font-black text-emerald-600">â‚¬ 0.00</p>
    </div>

    <div class="p-4 flex flex-col items-center bg-white m-4 rounded-3xl shadow-sm border border-slate-100">
        <h2 class="text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">Spese del Mese</h2>
        <div style="width: 100%; max-width: 280px;">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <div class="flex justify-center gap-10 my-8">
        <button onclick="openModal('uscita')" class="bg-red-500 hover:scale-110 transition-transform text-white w-16 h-16 rounded-full text-3xl shadow-xl shadow-red-200 font-bold">-</button>
        <button onclick="openModal('entrata')" class="bg-emerald-500 hover:scale-110 transition-transform text-white w-16 h-16 rounded-full text-3xl shadow-xl shadow-emerald-200 font-bold">+</button>
    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-4 text-[10px] font-bold text-gray-400 z-20">
        <a href="index.html" class="text-slate-800 flex flex-col items-center gap-1">ğŸ  <span>Home</span></a>
        <a href="risparmi.html" class="flex flex-col items-center gap-1">ğŸ’° <span>Risparmi</span></a>
        <a href="abbonamenti.html" class="flex flex-col items-center gap-1">ğŸ“º <span>Abbonamenti</span></a>
        <a href="satispay.html" class="flex flex-col items-center gap-1">ğŸ“± <span>Satispay</span></a>
        <a href="analisi.html" class="flex flex-col items-center gap-1">ğŸ“ˆ <span>Analisi</span></a>
    </nav>

    <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end sm:items-center justify-center z-50">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 animate-slide-up">
            <h2 id="modalTitle" class="text-2xl font-black mb-6 text-slate-800">Nuova Operazione</h2>
            <form id="transactionForm" class="space-y-5">
                <input type="hidden" id="tipo">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Categoria</label>
                    <select id="categoria" class="w-full p-4 border-none rounded-2xl bg-slate-100 text-slate-700 font-semibold focus:ring-2 focus:ring-slate-300" required></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Importo (â‚¬)</label>
                    <input type="number" id="importo" step="0.01" class="w-full p-4 border-none rounded-2xl bg-slate-100 text-slate-700 font-bold text-xl" placeholder="0.00" required>
                </div>
                <div id="metodoPagamentoDiv">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Metodo</label>
                    <select id="metodo" class="w-full p-4 border-none rounded-2xl bg-slate-100 text-slate-700 font-semibold">
                        <option value="Carta">Carta ğŸ’³</option>
                        <option value="Satispay">Satispay ğŸ“±</option>
                        <option value="Contanti">Contanti ğŸ’µ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Descrizione</label>
                    <input type="text" id="descrizione" class="w-full p-4 border-none rounded-2xl bg-slate-100 text-slate-700 font-semibold" placeholder="Es: Pizza">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Data</label>
                    <input type="date" id="data" class="w-full p-4 border-none rounded-2xl bg-slate-100 text-slate-700 font-semibold">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 py-4 text-gray-400 font-bold hover:bg-slate-50 rounded-2xl">Annulla</button>
                    <button type="submit" class="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vdbgzqzquuvvcqgntsgh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYmd6cXpxdXV2dmNxZ250c2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MjY2MDEsImV4cCI6MjA4NzUwMjYwMX0.pTjNAQ6dYb0zNbL7DW2yf9ud50tsn1GrfIsX1XA0oXE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ctx = document.getElementById('myChart').getContext('2d');
        let myChart = new Chart(ctx, {
            type: 'pie',
            data: { 
                labels: [], 
                datasets: [{ 
                    data: [], 
                    backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6', '#f472b6', '#64748b'],
                    borderWidth: 0 
                }] 
            },
            options: { plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
        });

        const categorieUscita = ["Spesa ğŸ›’", "Svago ğŸ¿", "Affitto ğŸ ", "Trasporti ğŸš—", "Abbonamenti ğŸ“º", "Salute ğŸ’Š", "Risparmi ğŸ’°"];
        const categorieEntrata = ["Stipendio ğŸ’°", "Regalo ğŸ", "Extra ğŸ“ˆ"];
        document.getElementById('data').valueAsDate = new Date();

        function openModal(tipo) {
            document.getElementById('tipo').value = tipo;
            const cats = tipo === 'entrata' ? categorieEntrata : categorieUscita;
            document.getElementById('categoria').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('metodoPagamentoDiv').style.display = tipo === 'entrata' ? 'none' : 'block';
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function refreshData() {
            const dataOggi = new Date();
            const primoDelMese = new Date(dataOggi.getFullYear(), dataOggi.getMonth(), 1).toISOString();
            const { data } = await supabaseClient.from('transactions').select('*').gte('data_transazione', primoDelMese);
            
            let saldo = 0;
            const aggregato = {};
            data?.forEach(t => {
                if (t.tipo === 'entrata') saldo += t.importo;
                else {
                    saldo -= t.importo;
                    aggregato[t.categoria] = (aggregato[t.categoria] || 0) + t.importo;
                }
            });
            document.getElementById('totalBalance').innerText = `â‚¬ ${saldo.toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
            document.getElementById('totalBalance').className = saldo >= 0 ? "text-2xl font-black text-emerald-600" : "text-2xl font-black text-red-600";
            
            myChart.data.labels = Object.keys(aggregato);
            myChart.data.datasets[0].data = Object.values(aggregato);
            myChart.update();
        }

        async function checkAutomatismi() {
            const oggi = new Date();
            const primoMese = new Date(oggi.getFullYear(), oggi.getMonth(), 1).toISOString();
            const giorno = oggi.getDate();

            // Check PAC (Risparmi)
            const { data: piani } = await supabaseClient.from('savings').select('*');
            for (const p of piani || []) {
                if (giorno >= p.giorno_prelievo) {
                    const { data: ex } = await supabaseClient.from('transactions').select('*').eq('descrizione', `AUTO-PAC: ${p.nome_piano}`).gte('data_transazione', primoMese);
                    if (ex?.length === 0) {
                        await supabaseClient.from('transactions').insert([{ tipo: 'uscita', categoria: 'Risparmi ğŸ’°', importo: p.importo_mensile, metodo_pagamento: 'Conto', descrizione: `AUTO-PAC: ${p.nome_piano}`, data_transazione: oggi.toISOString().split('T')[0] }]);
                    }
                }
            }

            // Check Abbonamenti
            const { data: subs } = await supabaseClient.from('subscriptions').select('*');
            for (const s of subs || []) {
                if (giorno >= s.data_prelievo) {
                    const { data: ex } = await supabaseClient.from('transactions').select('*').eq('descrizione', `AUTO-SUB: ${s.nome}`).gte('data_transazione', primoMese);
                    if (ex?.length === 0) {
                        await supabaseClient.from('transactions').insert([{ tipo: 'uscita', categoria: 'Abbonamenti ğŸ“º', importo: s.costo, metodo_pagamento: 'Carta', descrizione: `AUTO-SUB: ${s.nome}`, data_transazione: oggi.toISOString().split('T')[0] }]);
                    }
                }
            }
            refreshData();
        }

        document.getElementById('transactionForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                tipo: document.getElementById('tipo').value,
                categoria: document.getElementById('categoria').value,
                importo: parseFloat(document.getElementById('importo').value),
                metodo_pagamento: document.getElementById('metodo').value,
                descrizione: document.getElementById('descrizione').value,
                data_transazione: document.getElementById('data').value
            };
            await supabaseClient.from('transactions').insert([payload]);
            closeModal();
            checkAutomatismi();
            document.getElementById('transactionForm').reset();
            document.getElementById('data').valueAsDate = new Date();
        };

        checkAutomatismi();
    </script>
    <style> 
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } } 
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); } 
    </style>
</body>
</html>
