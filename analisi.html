<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Analisi Spese</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 pb-32 font-sans text-slate-900">

    <div class="p-6 bg-white shadow-sm border-b sticky top-0 z-40">
        <h1 class="text-lg font-black uppercase tracking-widest text-slate-800 text-center">Analisi Spese</h1>
    </div>

    <div class="p-4 space-y-6">
        
        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 text-center">Mese Corrente vs Precedente</p>
            <div class="flex justify-around items-center">
                <div class="text-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase">Mese Scorso</p>
                    <h3 id="prevMonthTotal" class="text-xl font-bold text-slate-400">â‚¬ 0.00</h3>
                </div>
                <div class="h-8 w-[1px] bg-slate-100"></div>
                <div class="text-center">
                    <p class="text-[9px] font-bold text-slate-800 uppercase">Questo Mese</p>
                    <h3 id="currMonthTotal" class="text-2xl font-black text-slate-800">â‚¬ 0.00</h3>
                </div>
            </div>
            <div id="monthTrend" class="mt-4 text-center text-[10px] font-bold py-2 rounded-full px-4 inline-block mx-auto w-full">Calcolo in corso...</div>
        </div>

        <div class="bg-slate-800 p-6 rounded-[2.5rem] shadow-xl text-white">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 text-center">Ultimi 6 Mesi vs Precedenti 6</p>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-700/50 p-4 rounded-2xl text-center">
                    <p class="text-[8px] font-bold opacity-60 uppercase mb-1">Precedenti 6</p>
                    <span id="prevSixTotal" class="text-sm font-bold">â‚¬ 0.00</span>
                </div>
                <div class="bg-emerald-500/20 p-4 rounded-2xl text-center border border-emerald-500/30">
                    <p class="text-[8px] font-bold opacity-60 uppercase mb-1">Ultimi 6</p>
                    <span id="currSixTotal" class="text-sm font-bold">â‚¬ 0.00</span>
                </div>
            </div>
            <p id="sixMonthTrend" class="text-center text-[10px] mt-4 font-bold opacity-80 uppercase tracking-tighter">--</p>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 relative overflow-hidden">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">Spesa Totale quest'anno</p>
            <div class="flex items-baseline gap-2">
                <h2 id="currYearTotal" class="text-3xl font-black text-slate-800">â‚¬ 0.00</h2>
            </div>
            <div class="mt-1 flex items-center gap-1">
                <span id="yearDiff" class="text-[10px] font-bold text-slate-400 uppercase">Caricamento...</span>
            </div>
            <div class="w-full bg-slate-100 h-1.5 rounded-full mt-4">
                <div id="yearBar" class="bg-slate-800 h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
            </div>
        </div>

    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-4 text-[10px] font-bold text-gray-400 z-40">
        <a href="index.html" class="flex flex-col items-center gap-1">ğŸ  <span>Home</span></a>
        <a href="risparmi.html" class="flex flex-col items-center gap-1">ğŸ’° <span>Risparmi</span></a>
        <a href="abbonamenti.html" class="flex flex-col items-center gap-1">ğŸ“º <span>Abbonamenti</span></a>
        <a href="satispay.html" class="flex flex-col items-center gap-1">ğŸ“± <span>Satispay</span></a>
        <a href="analisi.html" class="text-slate-800 flex flex-col items-center gap-1">ğŸ“ˆ <span>Analisi</span></a>
    </nav>

    <script>
        const SUPABASE_URL = 'https://vdbgzqzquuvvcqgntsgh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYmd6cXpxdXV2dmNxZ250c2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MjY2MDEsImV4cCI6MjA4NzUwMjYwMX0.pTjNAQ6dYb0zNbL7DW2yf9ud50tsn1GrfIsX1XA0oXE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function runAnalysis() {
            const { data: trans } = await supabaseClient.from('transactions').select('*');
            if (!trans) return;

            const now = new Date();
            // Inizio periodi
            const startOfCurrMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfPrevMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            
            const startOfCurrSix = new Date(now.getFullYear(), now.getMonth() - 5, 1);
            const startOfPrevSix = new Date(now.getFullYear(), now.getMonth() - 11, 1);

            const startOfCurrYear = new Date(now.getFullYear(), 0, 1);
            const startOfPrevYear = new Date(now.getFullYear() - 1, 0, 1);

            let stats = {
                currMonth: 0, prevMonth: 0,
                currSix: 0, prevSix: 0,
                currYear: 0, prevYear: 0
            };

            trans.forEach(t => {
                const d = new Date(t.data_transazione);
                // SOLO USCITE (Valore negativo nel DB)
                if (t.importo > 0) {
                    const val = Math.abs(parseFloat(t.importo));

                    // Mese
                    if (d >= startOfCurrMonth) stats.currMonth += val;
                    else if (d >= startOfPrevMonth && d < startOfCurrMonth) stats.prevMonth += val;

                    // 6 Mesi
                    if (d >= startOfCurrSix) stats.currSix += val;
                    else if (d >= startOfPrevSix && d < startOfCurrSix) stats.prevSix += val;

                    // Anno
                    if (d >= startOfCurrYear) stats.currYear += val;
                    else if (d >= startOfPrevYear && d < startOfCurrYear) stats.prevYear += val;
                }
            });

            updateUI(stats);
        }

        function getTrend(curr, prev) {
            if (prev === 0) return { label: "Nessun dato precedente", color: "text-slate-400", bg: "bg-slate-100" };
            const diff = ((curr - prev) / prev) * 100;
            const isWorse = diff > 0; // Se spendi di piÃ¹, Ã¨ peggio (Rosso)
            return {
                label: `${isWorse ? 'â–²' : 'â–¼'} ${Math.abs(diff).toFixed(1)}% rispetto al periodo precedente`,
                color: isWorse ? "text-rose-600" : "text-emerald-600",
                bg: isWorse ? "bg-rose-50" : "bg-emerald-50"
            };
        }

        function updateUI(s) {
            // Mese
            document.getElementById('currMonthTotal').innerText = `â‚¬ ${s.currMonth.toFixed(2)}`;
            document.getElementById('prevMonthTotal').innerText = `â‚¬ ${s.prevMonth.toFixed(2)}`;
            const mTrend = getTrend(s.currMonth, s.prevMonth);
            const mt = document.getElementById('monthTrend');
            mt.innerText = mTrend.label;
            mt.className = `mt-4 text-center text-[10px] font-bold py-2 rounded-full px-4 inline-block mx-auto w-full ${mTrend.bg} ${mTrend.color}`;

            // Semestre
            document.getElementById('currSixTotal').innerText = `â‚¬ ${s.currSix.toFixed(2)}`;
            document.getElementById('prevSixTotal').innerText = `â‚¬ ${s.prevSix.toFixed(2)}`;
            const sTrend = getTrend(s.currSix, s.prevSix);
            document.getElementById('sixMonthTrend').innerText = sTrend.label;
            document.getElementById('sixMonthTrend').className = `text-center text-[10px] mt-4 font-bold uppercase tracking-tighter ${sTrend.color.replace('600', '400')}`;

            // Anno
            document.getElementById('currYearTotal').innerText = `â‚¬ ${s.currYear.toFixed(2)}`;
            const yDiff = s.currYear - s.prevYear;
            const yTrend = getTrend(s.currYear, s.prevYear);
            document.getElementById('yearDiff').innerText = `${yDiff >= 0 ? '+' : ''}â‚¬ ${yDiff.toFixed(2)} rispetto all'anno scorso`;
            document.getElementById('yearDiff').className = `text-[10px] font-bold uppercase ${yTrend.color}`;
            
            const yPerc = s.prevYear > 0 ? Math.min((s.currYear / s.prevYear) * 100, 100) : 100;
            document.getElementById('yearBar').style.width = yPerc + '%';
        }

        runAnalysis();
    </script>
</body>
</html>
