<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Piani di Accumulo - MoneyTracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 pb-32 font-sans text-slate-900">

    <div class="p-6 bg-white shadow-sm border-b sticky top-0 z-40">
        <h1 class="text-xl font-black uppercase tracking-widest text-slate-800 text-center">I Miei Risparmi</h1>
    </div>

    <div class="m-4 p-6 bg-slate-800 rounded-[2.5rem] text-white shadow-xl">
        <p class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-60 mb-1">Totale Accumulato</p>
        <h2 id="grandTotalSavings" class="text-4xl font-black">‚Ç¨ 0.00</h2>
    </div>

    <div class="mx-4 space-y-4" id="pacList">
        </div>

    <button onclick="document.getElementById('modalPAC').classList.remove('hidden')" class="fixed bottom-24 right-6 bg-slate-800 text-white w-14 h-14 rounded-full text-2xl shadow-xl font-bold z-30">+</button>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-4 text-[10px] font-bold text-gray-400 z-40">
        <a href="index.html" class="flex flex-col items-center gap-1">üè† <span>Home</span></a>
        <a href="risparmi.html" class="text-slate-800 flex flex-col items-center gap-1">üí∞ <span>Risparmi</span></a>
        <a href="abbonamenti.html" class="flex flex-col items-center gap-1">üì∫ <span>Abbonamenti</span></a>
        <a href="satispay.html" class="flex flex-col items-center gap-1">üì± <span>Satispay</span></a>
        <a href="analisi.html" class="flex flex-col items-center gap-1">üìà <span>Analisi</span></a>
    </nav>

    <div id="modalPAC" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-end justify-center z-50">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] p-8 animate-slide-up">
            <h2 class="text-2xl font-black mb-6">Nuovo Piano</h2>
            <form id="pacForm" class="space-y-4">
                <input type="text" id="nomePAC" class="w-full p-4 bg-slate-100 rounded-2xl font-semibold border-none" placeholder="Nome (es. Fondo Vacanze)" required>
                <input type="number" id="importoPAC" step="0.01" class="w-full p-4 bg-slate-100 rounded-2xl font-bold text-xl border-none" placeholder="Importo mensile" required>
                <input type="number" id="giornoPAC" min="1" max="28" class="w-full p-4 bg-slate-100 rounded-2xl font-semibold border-none" placeholder="Giorno prelievo (1-28)" required>
                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="document.getElementById('modalPAC').classList.add('hidden')" class="flex-1 py-4 text-gray-400 font-bold">Annulla</button>
                    <button type="submit" class="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-bold">Attiva</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vdbgzqzquuvvcqgntsgh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYmd6cXpxdXV2dmNxZ250c2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MjY2MDEsImV4cCI6MjA4NzUwMjYwMX0.pTjNAQ6dYb0zNbL7DW2yf9ud50tsn1GrfIsX1XA0oXE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadPACs() {
            // 1. Prendi i piani
            const { data: plans } = await supabaseClient.from('savings').select('*');
            // 2. Prendi tutte le transazioni di tipo risparmio (AUTO-PAC)
            const { data: trans } = await supabaseClient.from('transactions').select('*').ilike('descrizione', 'AUTO-PAC%');

            let listHtml = '';
            let totaleGenerale = 0;

            plans?.forEach(plan => {
                // Calcola quanto √® stato accumulato per QUESTO specifico piano
                const accumulato = trans
                    ?.filter(t => t.descrizione === `AUTO-PAC: ${plan.nome_piano}`)
                    .reduce((sum, t) => sum + t.importo, 0) || 0;

                totaleGenerale += accumulato;

                listHtml += `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex justify-between items-center">
                    <div>
                        <h3 class="font-black text-slate-800 text-lg">${plan.nome_piano}</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                            Contributo: ‚Ç¨${plan.importo_mensile.toFixed(2)}/mese (Giorno ${plan.giorno_prelievo})
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-emerald-500 font-black uppercase tracking-widest mb-1">Accumulato</p>
                        <p class="text-xl font-black text-slate-800">‚Ç¨ ${accumulato.toFixed(2)}</p>
                    </div>
                </div>`;
            });

            document.getElementById('pacList').innerHTML = listHtml || '<p class="text-center text-slate-400 py-10">Nessun piano attivo</p>';
            document.getElementById('grandTotalSavings').innerText = `‚Ç¨ ${totaleGenerale.toFixed(2)}`;
        }

        document.getElementById('pacForm').onsubmit = async (e) => {
            e.preventDefault();
            await supabaseClient.from('savings').insert([{
                nome_piano: document.getElementById('nomePAC').value,
                importo_mensile: parseFloat(document.getElementById('importoPAC').value),
                giorno_prelievo: parseInt(document.getElementById('giornoPAC').value)
            }]);
            document.getElementById('modalPAC').classList.add('hidden');
            loadPACs();
        };

        loadPACs();
    </script>
</body>
</html>
